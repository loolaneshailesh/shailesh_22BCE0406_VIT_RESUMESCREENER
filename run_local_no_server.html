<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Resume Screener (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'space-primary': '#0e7490', // Deep Cyan
              'space-secondary': '#be185d', // Deep Pink/Magenta
              'space-accent': '#6d28d9', // Deep Violet
              'brand-primary': '#0891b2',
              'brand-secondary': '#db2777',
            },
            fontFamily: {
              sans: ['"Exo 2"', 'sans-serif'],
            },
            textShadow: {
              'glow': '0 0 8px var(--tw-shadow-color)',
            },
            boxShadow: {
              'glow': '0 0 15px var(--tw-shadow-color)',
              'glow-lg': '0 0 25px var(--tw-shadow-color)',
            },
            keyframes: {
              'pulse-glow': {
                '0%, 100%': { opacity: 1, boxShadow: '0 0 15px var(--tw-shadow-color)' },
                '50%': { opacity: 0.8, boxShadow: '0 0 25px var(--tw-shadow-color)' },
              }
            },
            animation: {
              'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          },
        },
        plugins: [
          function({ addUtilities, theme }) {
            const newUtilities = {
              '.text-shadow-glow': {
                textShadow: theme('textShadow.glow'),
              },
            }
            addUtilities(newUtilities, ['responsive', 'hover'])
          }
        ],
      }
    </script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/genai": "https://esm.sh/@google/genai@1.27.0",
        "pdfjs-dist": "https://esm.sh/pdfjs-dist@4.4.168"
      }
    }
    </script>
    <!-- Babel for JSX compilation MUST be in the head -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";
      import * as pdfjsLib from 'pdfjs-dist';

      // --- SETUP ---
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.mjs`;

      let ai; // Global AI instance

      // --- ICONS (Components) ---
      const ClockIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      );
      const HistoryIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M1 4v6h6" />
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
        </svg>
      );
      const TrashIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      );
      const SparklesIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3Z"/>
            <path d="M5 21L6.5 18"/>
            <path d="M17.5 18L19 21"/>
            <path d="M21 5L18 6.5"/>
            <path d="M3 5L6 6.5"/>
          </svg>
      );
      const LightbulbIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M15.09 16.05A6.49 6.49 0 0 0 12 10c-1.84 0-3.53.77-4.74 2.06" />
          <path d="M12 2a7 7 0 0 0-7 7c0 2.22 1.02 4.22 2.62 5.51" />
          <path d="M16.38 17.51A7 7 0 0 0 19 12a7 7 0 0 0-7-7" />
          <path d="m5 21 1-1" />
          <path d="m18 21 1-1" />
          <path d="M12 18v3" />
          <path d="M8 21h8" />
        </svg>
      );
      const SendIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      );
      const ClipboardIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
      );
      const PlusIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      );
      const LoadingSpinner = () => (
        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style={{color: 'currentColor'}}>
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      );

      // --- SERVICES: fileParsers.js ---
      async function parseTxt(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target?.result);
          reader.onerror = () => reject(new Error("Failed to read the text file."));
          reader.readAsText(file);
        });
      }
      async function parsePdf(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const arrayBuffer = e.target?.result;
              if (!arrayBuffer) {
                  return reject(new Error('Failed to read PDF file into buffer.'));
              }
              const typedArray = new Uint8Array(arrayBuffer);
              const pdf = await pdfjsLib.getDocument(typedArray).promise;
              let fullText = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => ('str' in item ? item.str : '')).join(' ');
                fullText += pageText + '\n\n';
              }
              resolve(fullText);
            } catch (error) {
              console.error('Error parsing PDF:', error);
              reject(new Error('Failed to parse PDF content. The file might be corrupted or protected.'));
            }
          };
          reader.onerror = () => reject(new Error('Failed to read the PDF file.'));
          reader.readAsArrayBuffer(file);
        });
      }
      async function parseFile(file) {
        const extension = file.name.split('.').pop()?.toLowerCase();
        if (extension === 'txt' || file.type === 'text/plain') {
          return parseTxt(file);
        } else if (extension === 'pdf' || file.type === 'application/pdf') {
          return parsePdf(file);
        } else {
          throw new Error(`Unsupported file type: '${extension}'. Please upload a .txt or .pdf file.`);
        }
      }

      // --- DATA: presetRoles.js ---
      const PRESET_ROLES = [
          { title: "Backend Developer", description: "We are seeking an experienced Backend Developer..." },
          { title: "Business Analyst", description: "We are looking for a Business Analyst..." },
          { title: "Cloud Engineer", description: "We are seeking a skilled Cloud Engineer..." },
          { title: "Content Strategist", description: "We are looking for a Content Strategist..." },
          { title: "Customer Support Representative", description: "We are looking for a Customer-oriented Service Representative..." },
          { title: "Cybersecurity Analyst", description: "We are seeking a Cybersecurity Analyst..." },
          { title: "Data Scientist", description: "We are looking for a Data Scientist..." },
          { title: "Database Administrator (DBA)", description: "We are looking for a skilled Database Administrator..." },
          { title: "DevOps Engineer", description: "We are looking for a DevOps Engineer..." },
          { title: "Digital Marketing Specialist", description: "We are looking for a Digital Marketing Specialist..." },
          { title: "Financial Analyst", description: "We are looking for a Financial Analyst..." },
          { title: "Frontend Developer", description: "We are looking for a skilled Frontend Developer..." },
          { title: "Full-Stack Developer", description: "We are looking for a Full-Stack Developer..." },
          { title: "Graphic Designer", description: "We are looking for a creative Graphic Designer..." },
          { title: "Human Resources (HR) Manager", description: "We are looking for an HR Manager..." },
          { title: "IT Support Specialist", description: "We are seeking an IT Support Specialist..." },
          { title: "Marketing Manager", description: "We are looking for a Marketing Manager..." },
          { title: "Mobile App Developer (iOS/Android)", description: "Seeking a Mobile App Developer..." },
          { title: "Network Engineer", description: "We are looking for a Network Engineer..." },
          { title: "Product Manager", description: "We are looking for an experienced Product Manager..." },
          { title: "Project Manager", description: "We are looking for an experienced Project Manager..." },
          { title: "Software Engineer in Test (SDET)", description: "We are looking for a Software Development Engineer in Test..." },
          { title: "Systems Administrator", description: "We are looking for a System Administrator..." },
          { title: "UX/UI Designer", description: "We are looking for a talented UX/UI Designer..." }
      ].map(role => ({
          ...role,
          description: role.description.replace(/\.{3,}/, (match) => {
              const fullDescriptions = {
                  "Backend Developer": `We are seeking an experienced Backend Developer to join our IT team. You will be responsible for the server-side of our web applications. If you have excellent programming skills and a passion for developing applications or improving existing ones, we would like to meet you.\n\nResponsibilities:\n- Participate in the entire application lifecycle, focusing on coding and debugging.\n- Write clean code to develop functional web applications.\n- Troubleshoot and debug applications.\n- Perform UI tests to optimize performance.\n- Manage cutting-edge technologies to improve legacy applications.\n- Collaborate with Frontend developers to integrate user-facing elements with server-side logic.\n- Gather and address technical and design requirements.\n- Provide training and support to internal teams.\n- Build reusable code and libraries for future use.\n- Liaise with developers, designers and system administrators to identify new features.\n\nRequirements:\n- Proven experience as a Backend Developer.\n- In-depth understanding of the entire web development process (design, development and deployment).\n- Hands on experience with programming languages like Java, Ruby, Python, PHP and .Net.\n- Familiarity with front-end languages (e.g. HTML, JavaScript and CSS).\n- Excellent analytical and time management skills.`,
                  "Business Analyst": `We are looking for a Business Analyst to join our team. The main role of the Business Analyst is to analyze the business processes, identify areas of improvement, and recommend solutions to business problems.\n\nResponsibilities:\n- Elicit, analyze, and document business requirements.\n- Communicate with stakeholders to understand their needs and concerns.\n- Create detailed business analysis, outlining problems, opportunities, and solutions for a business.\n- Bridge the gap between IT and the business using data analytics to assess processes, determine requirements and deliver data-driven recommendations and reports to executives and stakeholders.\n\nRequirements:\n- Proven experience as a Business Analyst.\n- Experience with business process modeling.\n- Strong analytical and problem-solving skills.\n- Excellent communication and interpersonal skills.\n- Familiarity with project management methodologies like Agile and Scrum.`,
                  "Cloud Engineer": `We are seeking a skilled Cloud Engineer to work with our engineering team to develop, implement, optimize, and maintain cloud-based solutions. You will be responsible for deploying and debugging cloud stacks, educating teams on new cloud initiatives, and ensuring the security of the cloud infrastructure.\n\nResponsibilities:\n- Collaborate with engineering and development teams to evaluate and identify optimal cloud solutions.\n- Modify and improve existing systems.\n- Educate teams on the implementation of new cloud-based initiatives, providing associated training as required.\n- Employ exceptional problem-solving skills, with the ability to see and solve issues before they affect business productivity.\n- Design, develop and deploy modular cloud-based systems.\n- Develop and maintain cloud-based solutions in accordance with best practices.\n- Ensure the security of the cloud-based infrastructure.\n\nRequirements:\n- Bachelor's degree in Computer Science, Information Technology, or a related field.\n- Proven experience as a Cloud Engineer or similar role.\n- Experience with cloud platforms (e.g., AWS, Azure, Google Cloud).\n- Knowledge of cloud security, networking, and infrastructure as code (IaC) tools like Terraform or CloudFormation.\n- Experience with containerization technologies, such as Docker and Kubernetes.`,
                  "Content Strategist": `We are looking for a Content Strategist to oversee all marketing content initiatives to ensure customer engagement, brand consistency and a positive customer experience. You will be responsible for creating and implementing a content strategy that aligns with our business goals.\n\nResponsibilities:\n- Develop a content strategy aligned with short-term and long-term marketing targets.\n- Collaborate with marketing and design teams to plan and develop site content, style, and layout.\n- Create and publish engaging content.\n- Edit, proofread and improve other writersâ€™ posts.\n- Liaise with content writers to ensure brand consistency.\n- Optimize content according to SEO.\n- Use content management systems to analyze website traffic and user engagement metrics.\n\nRequirements:\n- Proven work experience as a Content Strategist, Content Manager or similar role.\n- Portfolio of published articles.\n- Experience with content management systems (e.g., WordPress).\n- Knowledge of SEO and web traffic metrics.\n- Excellent writing and editing skills in English.`,
                  "Customer Support Representative": `We are looking for a Customer-oriented Service Representative. A customer service representative, or CSR, will act as a liaison, provide product/services information and resolve any emerging problems that our customer accounts might face with accuracy and efficiency.\n\nResponsibilities:\n- Manage large amounts of incoming calls.\n- Generate sales leads.\n- Identify and assess customersâ€™ needs to achieve satisfaction.\n- Build sustainable relationships and trust with customer accounts through open and interactive communication.\n- Provide accurate, valid and complete information by using the right methods/tools.\n- Handle customer complaints, provide appropriate solutions and alternatives within the time limits; follow up to ensure resolution.\n\nRequirements:\n- Proven customer support experience or experience as a client service representative.\n- Strong phone contact handling skills and active listening.\n- Familiarity with CRM systems and practices.\n- Customer orientation and ability to adapt/respond to different types of characters.\n- Excellent communication and presentation skills.`,
                  "Cybersecurity Analyst": `We are seeking a Cybersecurity Analyst to protect our computer networks and systems. You will be responsible for identifying and mitigating security threats, implementing security measures, and responding to security incidents.\n\nResponsibilities:\n- Monitor computer networks for security issues.\n- Investigate security breaches and other cybersecurity incidents.\n- Install security measures and operate software to protect systems and information infrastructure, including firewalls and data encryption programs.\n- Document security breaches and assess the damage they cause.\n- Work with the security team to perform tests and uncover network vulnerabilities.\n- Fix detected vulnerabilities to maintain a high-security standard.\n\nRequirements:\n- Proven experience as a Cybersecurity Analyst or similar role.\n- Experience with firewalls, antivirus software, and intrusion detection systems.\n- Knowledge of risk assessment tools, technologies, and methods.\n- Understanding of cybersecurity frameworks (e.g., NIST, ISO 27001).\n- Strong analytical and problem-solving skills.`,
                  "Data Scientist": `We are looking for a Data Scientist to analyze large amounts of raw information to find patterns that will help improve our company. We will rely on you to build data products to extract valuable business insights.\n\nResponsibilities:\n- Identify valuable data sources and automate collection processes.\n- Undertake preprocessing of structured and unstructured data.\n- Analyze large amounts of information to discover trends and patterns.\n- Build predictive models and machine-learning algorithms.\n- Combine models through ensemble modeling.\n- Present information using data visualization techniques.\n- Propose solutions and strategies to business challenges.\n\nRequirements:\n- Proven experience as a Data Scientist or Data Analyst.\n- Experience in data mining.\n- Understanding of machine-learning and operations research.\n- Knowledge of R, SQL and Python; familiarity with Scala, Java or C++ is an asset.\n- Experience using business intelligence tools (e.g. Tableau) and data frameworks (e.g. Hadoop).`,
                  "Database Administrator (DBA)": `We are looking for a skilled Database Administrator (DBA) who will be responsible for the performance, integrity, and security of our databases. You will also be involved in the planning and development of the database, as well as troubleshooting any issues on behalf of the users.\n\nResponsibilities:\n- Manage database security, integrity, and backup procedures.\n- Write database documentation, including data standards, procedures, and definitions for the data dictionary (metadata).\n- Control access permissions and privileges.\n- Develop, manage, and test back-up and recovery plans.\n- Ensure that storage and archiving procedures are functioning correctly.\n- Carry out capacity planning.\n- Work closely with IT project managers, database programmers, and multimedia programmers.\n\nRequirements:\n- Proven working experience as a Database Administrator.\n- Hands-on experience with database standards and end-user applications.\n- Excellent knowledge of data backup, recovery, security, integrity, and SQL.\n- Familiarity with database design, documentation, and coding.\n- Experience with DBA case tools (frontend/backend) and third-party tools.`,
                  "DevOps Engineer": `We are looking for a DevOps Engineer to help us build functional systems that improve customer experience. DevOps Engineer responsibilities include deploying product updates, identifying production issues and implementing integrations that meet customer needs.\n\nResponsibilities:\n- Build and set up new development tools and infrastructure.\n- Understand the needs of stakeholders and convey this to developers.\n- Work on ways to automate and improve development and release processes.\n- Test and examine code written by others and analyze results.\n- Ensure that systems are safe and secure against cybersecurity threats.\n- Identify technical problems and develop software updates and â€˜fixesâ€™.\n- Work with software developers and software engineers to ensure that development follows established processes and works as intended.\n\nRequirements:\n- Proven experience as a DevOps Engineer or similar software engineering role.\n- Proficient with git and git workflows.\n- Good knowledge of Ruby or Python.\n- Working knowledge of databases and SQL.\n- Problem-solving attitude.`,
                  "Digital Marketing Specialist": `We are looking for a Digital Marketing Specialist to assist in the planning, execution, and optimization of our online marketing efforts. The ideal candidate will have a passion for all things marketing and technology.\n\nResponsibilities:\n- Assist in the formulation of strategies to build a lasting digital connection with consumers.\n- Plan and monitor the ongoing company presence on social media (Twitter, Facebook etc.).\n- Launch optimized online adverts through Google AdWords, Facebook etc. to increase company and brand awareness.\n- Be actively involved in SEO efforts (keyword, image optimization etc.).\n- Prepare online newsletters and promotional emails and organize their distribution through various channels.\n- Provide creative ideas for content marketing and update website.\n\nRequirements:\n- Proven experience as a Digital Marketing Specialist or similar role.\n- Excellent understanding of digital marketing concepts and best practices.\n- Experience with B2C social media, Google AdWords and email campaigns, and SEO/SEM.\n- Working knowledge of ad serving tools (e.g., DART, Atlas).\n- Perfect knowledge of web analytics tools (e.g., Google Analytics, NetInsight, WebTrends etc.).`,
                  "Financial Analyst": `We are looking for a Financial Analyst to provide accurate and data-based information on companyâ€™s profitability, solvency, stability and liquidity. You will research and analyze financial information to help the company make well-informed decisions, write reports and monitor financial movements.\n\nResponsibilities:\n- Consolidate and analyze financial data (budgets, income statement forecasts etc) taking into account companyâ€™s goals and financial standing.\n- Provide creative alternatives and recommendations to reduce costs and improve financial performance.\n- Assemble and summarize data to structure sophisticated reports on financial status and risks.\n- Develop financial models, conduct benchmarking and process analysis.\n- Conduct business studies on past, future and comparative performance and develop forecast models.\n\nRequirements:\n- Proven working experience as a Financial Analyst.\n- Proficient in spreadsheets, databases, MS Office and financial software applications.\n- Hands on experience with statistical analysis and statistical packages.\n- Outstanding presentation, reporting and communication skills.\n- BS degree in Finance, Economics or related field.`,
                  "Frontend Developer": `We are looking for a skilled Frontend Developer to join our team. The ideal candidate will be responsible for building the client-side of our web applications. You should be able to translate our company and customer needs into functional and appealing interactive applications.\n\nResponsibilities:\n- Use markup languages like HTML to create user-friendly web pages.\n- Maintain and improve website.\n- Optimize applications for maximum speed.\n- Design mobile-based features.\n- Collaborate with back-end developers and web designers to improve usability.\n- Get feedback from, and build solutions for, users and customers.\n- Write functional requirement documents and guides.\n- Create quality mockups and prototypes.\n- Help back-end developers with coding and troubleshooting.\n- Ensure high quality graphic standards and brand consistency.\n- Stay up-to-date on emerging technologies.\n\nRequirements:\n- Proven work experience as a Frontend Developer.\n- Proficient understanding of web markup, including HTML5, CSS3.\n- Basic understanding of server-side CSS pre-processing platforms, such as LESS and SASS.\n- Proficient understanding of client-side scripting and JavaScript frameworks, including React, Angular, or Vue.js.\n- Good understanding of asynchronous request handling, partial page updates, and AJAX.`,
                  "Full-Stack Developer": `We are looking for a Full-Stack Developer to produce scalable software solutions. Youâ€™ll be part of a cross-functional team thatâ€™s responsible for the full software development life cycle, from conception to deployment. As a Full-Stack Developer, you should be comfortable around both front-end and back-end coding languages, development frameworks and third-party libraries.\n\nResponsibilities:\n- Work with development teams and product managers to ideate software solutions.\n- Design client-side and server-side architecture.\n- Build the front-end of applications through appealing visual design.\n- Develop and manage well-functioning databases and applications.\n- Write effective APIs.\n- Test software to ensure responsiveness and efficiency.\n- Troubleshoot, debug and upgrade software.\n- Create security and data protection settings.\n\nRequirements:\n- Proven experience as a Full-Stack Developer or similar role.\n- Experience developing desktop and mobile applications.\n- Familiarity with common stacks.\n- Knowledge of multiple front-end languages and libraries (e.g. HTML/ CSS, JavaScript, XML, jQuery).\n- Knowledge of multiple back-end languages (e.g. C#, Java, Python) and JavaScript frameworks (e.g. Angular, React, Node.js).\n- Familiarity with databases (e.g. MySQL, MongoDB), web servers (e.g. Apache) and UI/UX design.`,
                  "Graphic Designer": `We are looking for a creative Graphic Designer with up-to-date knowledge to interpret our clientsâ€™ needs and to design solutions with high visual impact. You will work on a variety of products, including websites, books, magazines, product packaging, websites, exhibitions, corporate identity etc.\n\nResponsibilities:\n- Cultivate a solid body of work.\n- Take the design â€œbriefâ€ to record requirements and clientsâ€™ needs.\n- Schedule project implementation and define budget constraints.\n- Work with a wide range of media and use graphic design software.\n- Think creatively and develop new design concepts, graphics and layouts.\n- Prepare rough drafts and present your ideas.\n- Amend final designs to clientsâ€™ comments and gain full approval.\n\nRequirements:\n- Proven graphic designing experience.\n- A strong portfolio of illustrations or other graphics.\n- Familiarity with design software and technologies (such as InDesign, Illustrator, Dreamweaver, Photoshop).\n- A keen eye for aesthetics and details.\n- Excellent communication skills.`,
                  "Human Resources (HR) Manager": `We are looking for an HR Manager to oversee all aspects of human resources practices and processes. You will support business needs and ensure the proper implementation of company strategy and objectives.\n\nResponsibilities:\n- Develop and implement HR strategies and initiatives aligned with the overall business strategy.\n- Bridge management and employee relations by addressing demands, grievances or other issues.\n- Manage the recruitment and selection process.\n- Support current and future business needs through the development, engagement, motivation and preservation of human capital.\n- Develop and monitor overall HR strategies, systems, tactics and procedures across the organization.\n- Nurture a positive working environment.\n\nRequirements:\n- Proven working experience as an HR Manager or other HR Executive.\n- People-oriented and results-driven.\n- Demonstrable experience with human resources metrics.\n- Knowledge of HR systems and databases.\n- Ability to architect strategy along with leadership skills.`,
                  "IT Support Specialist": `We are seeking an IT Support Specialist to provide technical assistance and support to our employees. You will be the first point of contact for any technical issues, and you'll work to resolve them in a timely and efficient manner.\n\nResponsibilities:\n- Provide first-level contact and convey resolutions to customer issues.\n- Properly escalate unresolved queries to the next level of support.\n- Track, route, and redirect problems to correct resources.\n- Update customer data and produce activity reports.\n- Walk customers through the problem-solving process.\n- Install, modify, and repair computer hardware and software.\n\nRequirements:\n- Proven work experience as an IT Support Specialist or other technical support role.\n- Strong understanding of computer systems, mobile devices, and other tech products.\n- Ability to diagnose and resolve basic technical issues.\n- Excellent communication skills.\n- Customer-oriented and cool-tempered.`,
                  "Marketing Manager": `We are looking for a Marketing Manager to be responsible for developing, implementing and executing strategic marketing plans for an entire organization (or lines of business and brands within an organization) in order to attract potential customers and retain existing ones.\n\nResponsibilities:\n- Developing strategies and tactics to get the word out about our company and drive qualified traffic to our front door.\n- Deploying successful marketing campaigns and own their implementation from ideation to execution.\n- Experimenting with a variety of organic and paid acquisition channels like content creation, content curation, pay per click campaigns, event management, publicity, social media, lead generation campaigns, copywriting, performance analysis.\n- Producing valuable and engaging content for our website and blog that attracts and converts our target groups.\n\nRequirements:\n- Demonstrable experience in marketing together with the potential and attitude required to learn.\n- Proven experience in identifying target audiences and in creatively devising and leading across channels marketing campaigns that engage, educate and motivate.\n- Solid knowledge of website analytics tools (e.g., Google Analytics, NetInsight, Omniture, WebTrends).\n- Numerically literate, comfortable working with numbers, making sense of metrics and processing figures with spreadsheets.`,
                  "Mobile App Developer (iOS/Android)": `Seeking a Mobile App Developer to design, develop, and maintain applications for mobile devices. You will be responsible for the full mobile application development lifecycle.\n\nResponsibilities:\n- Design and build advanced applications for the iOS and/or Android platform.\n- Collaborate with cross-functional teams to define, design, and ship new features.\n- Unit-test code for robustness, including edge cases, usability, and general reliability.\n- Work on bug fixing and improving application performance.\n- Continuously discover, evaluate, and implement new technologies to maximize development efficiency.\n\nRequirements:\n- BS/MS degree in Computer Science, Engineering or a related subject.\n- Proven software development experience and Android/iOS skills development.\n- Proven working experience in Android/iOS app development.\n- Experience with third-party libraries and APIs.\n- Working knowledge of the general mobile landscape, architectures, trends, and emerging technologies.`,
                  "Network Engineer": `We are looking for a Network Engineer to design, implement, maintain, and support our growing network infrastructure. You will be part of a systems engineering team that is responsible for designing and developing scalable, maintainable, highly available network architectures that meet business objectives and SLAs.\n\nResponsibilities:\n- Configure and install various network devices and services (e.g., routers, switches, firewalls, load balancers, VPN, QoS).\n- Perform network maintenance and system upgrades including service packs, patches, hot fixes, and security configurations.\n- Monitor performance and ensure system availability and reliability.\n- Monitor system resource utilization, trending, and capacity planning.\n- Provide Level-2/3 support and troubleshooting to resolve issues.\n\nRequirements:\n- Proven hands-on network engineering experience.\n- CCNP or higher (CCIE and/or CISSP highly valued).\n- Deep understanding of networking protocols (e.g., IPSEC, HSRP, BGP, OSPF, 802.11, QoS).\n- Solid understanding of the OSI or TCP/IP model.\n- Hands-on experience with monitoring, network diagnostic, and network analytics tools.`,
                  "Product Manager": `We are looking for an experienced Product Manager to be responsible for setting the strategy, roadmap, and feature definition for a product or product line. You will guide the success of a product and lead the cross-functional team that is responsible for improving it.\n\nResponsibilities:\n- Defines the product vision, strategy and roadmap.\n- Gathers, manages, and prioritizes market/customer requirements.\n- Acts as the customer advocate articulating the userâ€™s and/or buyerâ€™s needs.\n- Works closely with engineering, sales, marketing, and support to ensure business case and customer satisfaction goals are met.\n- Has technical product knowledge or specific domain expertise.\n- Defines what the product team will deliver and the timeline for implementation.\n\nRequirements:\n- Proven experience as a Product Manager or similar role.\n- Experience in product lifecycle management.\n- Background in software development and program management is preferred.\n- Familiarity with Agile framework.\n- Organizational and leadership abilities.`,
                  "Project Manager": `We are looking for an experienced Project Manager to manage organization of key client projects. Project Manager responsibilities include the coordination and completion of projects on time within budget and within scope. Oversee all aspects of projects. Set deadlines, assign responsibilities and monitor and summarize progress of project.\n\nResponsibilities:\n- Coordinate internal resources and third parties/vendors for the flawless execution of projects.\n- Ensure that all projects are delivered on-time, within scope and within budget.\n- Developing project scopes and objectives, involving all relevant stakeholders and ensuring technical feasibility.\n- Ensure resource availability and allocation.\n- Develop a detailed project plan to track progress.\n\nRequirements:\n- Proven working experience as a project administrator in the information technology sector.\n- Solid technical background, with understanding or hands-on experience in software development and web technologies.\n- Excellent client-facing and internal communication skills.\n- Excellent written and verbal communication skills.\n- Solid organizational skills including attention to detail and multi-tasking skills.`,
                  "Software Engineer in Test (SDET)": `We are looking for a Software Development Engineer in Test (SDET) to join our team. You will be responsible for developing and executing automated tests to ensure product quality. As an SDET, you should have a solid background in software development, a deep understanding of testing methodologies, and a passion for quality.\n\nResponsibilities:\n- Design, develop, and execute automation scripts using open-source tools.\n- Identify, record, document thoroughly, and track bugs.\n- Perform thorough regression testing when bugs are resolved.\n- Develop and apply testing processes for new and existing products to meet client needs.\n- Liaise with internal teams (e.g., developers and product managers) to identify system requirements.\n- Monitor debugging process results.\n- Investigate the causes of non-conforming software and train users to implement solutions.\n- Track quality assurance metrics, like defect densities and open defect counts.\n\nRequirements:\n- Proven work experience in software development.\n- Proven work experience in software quality assurance.\n- Strong knowledge of software QA methodologies, tools, and processes.\n- Experience in writing clear, concise, and comprehensive test plans and test cases.\n- Hands-on experience with both white box and black box testing.\n- Hands-on experience with automated testing tools (e.g., Selenium, Cypress).\n- Solid knowledge of SQL and scripting.\n- Experience working in an Agile/Scrum development process.`,
                  "Systems Administrator": `We are looking for a System Administrator to maintain, upgrade and manage our software, hardware and networks. Resourcefulness is a necessary skill in this role. You should be able to diagnose and resolve problems quickly. You should also have the patience to communicate with a variety of interdisciplinary teams and users.\n\nResponsibilities:\n- Install and configure software and hardware.\n- Manage network servers and technology tools.\n- Set up accounts and workstations.\n- Monitor performance and maintain systems according to requirements.\n- Troubleshoot issues and outages.\n- Ensure security through access controls, backups and firewalls.\n- Upgrade systems with new releases and models.\n- Develop expertise to train staff on new technologies.\n- Build an internal wiki with technical documentation, manuals and IT policies.\n\nRequirements:\n- Proven experience as a System Administrator, Network Administrator or similar role.\n- Experience with databases, networks (LAN, WAN) and patch management.\n- Knowledge of system security (e.g. intrusion detection systems) and data backup/recovery.\n- Familiarity with various operating systems and platforms (e.g., Windows, Linux, macOS).\n- Resourcefulness and problem-solving aptitude.`,
                  "UX/UI Designer": `We are looking for a talented UX/UI Designer to create amazing user experiences. The ideal candidate should have an eye for clean and artful design, possess superior UI skills and be able to translate high-level requirements into interaction flows and artifacts, and transform them into beautiful, intuitive, and functional user interfaces.\n\nResponsibilities:\n- Collaborate with product management and engineering to define and implement innovative solutions for the product direction, visuals and experience.\n- Execute all visual design stages from concept to final hand-off to engineering.\n- Conceptualize original ideas that bring simplicity and user friendliness to complex design roadblocks.\n- Create wireframes, storyboards, user flows, process flows and site maps to effectively communicate interaction and design ideas.\n- Present and defend designs and key milestone deliverables to peers and executive level stakeholders.\n\nRequirements:\n- Proven UI experience.\n- Demonstrable UI design skills with a strong portfolio.\n- Solid experience in creating wireframes, storyboards, user flows, process flows and site maps.\n- Proficiency in Photoshop, Illustrator, OmniGraffle, or other visual design and wire-framing tools.\n- Proficiency in HTML, CSS, and JavaScript for rapid prototyping.`
              };
              return fullDescriptions[role.title] || match;
          })
      }));


      // --- SERVICES: geminiService.js (Standalone Version) ---
      const candidateSchema = {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            id: { type: Type.STRING, description: 'The resume ID from the input' },
            name: { type: Type.STRING, description: "The candidate's full name" },
            matchScore: { type: Type.INTEGER, description: 'A score from 1 to 10 indicating the match with the job description.' },
            justification: { type: Type.STRING, description: 'A concise (2-3 sentences) justification for the match score.' },
            extractedSkills: { type: Type.ARRAY, items: { type: Type.STRING }, description: 'A list of key skills extracted from the resume that are relevant to the job description.' },
            extractedExperienceSummary: { type: Type.STRING, description: 'A brief (2-3 sentences) summary of the candidate\'s relevant work experience.' }
          },
          required: ['id', 'name', 'matchScore', 'justification', 'extractedSkills', 'extractedExperienceSummary']
        }
      };

      const analyzeResumes = async (jobDescription, resumes) => {
        const resumeTexts = resumes.map(r => `--- RESUME START ---\nID: ${r.id}\nFILENAME: ${r.fileName}\n\n${r.text}\n--- RESUME END ---`).join('\n\n');
        const prompt = `
          You are an expert technical recruiter. Your task is to analyze a list of resumes against a given job description and provide a structured JSON output based on the provided schema.
          JOB DESCRIPTION:
          ${jobDescription}
          RESUMES TO ANALYZE:
          ${resumeTexts}
          INSTRUCTIONS:
          1. Read the job description to understand key requirements.
          2. For each resume, provide:
              a. The candidate's name. Use the filename or "Unknown Candidate" if not found.
              b. A "matchScore" from 1 to 10 based on how well the candidate's skills and experience align with the job description.
              c. A concise "justification" (2-3 sentences) for the score.
              d. A list of "extractedSkills" from the resume relevant to the job.
              e. A brief "extractedExperienceSummary" (2-3 sentences) of their relevant work history.
          3. Your output MUST conform to the JSON schema provided in the request.
        `;
        try {
          const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: [{ parts: [{ text: prompt }] }],
            config: { responseMimeType: "application/json", responseSchema: candidateSchema }
          });
          const jsonText = response.text;
          const parsedData = JSON.parse(jsonText);
          return parsedData;
        } catch (error) {
          console.error("Failed to analyze resumes:", error);
          if (error instanceof SyntaxError) throw new Error("Could not parse the analysis from the AI model. The response was not valid JSON.");
          throw error;
        }
      };
      
      const streamApiCall = async (prompt) => {
        try {
          const stream = await ai.models.generateContentStream({
            model: 'gemini-2.5-flash',
            contents: [{ parts: [{ text: prompt }] }],
          });
          let fullText = "";
          for await (const chunk of stream) {
            fullText += chunk.text;
          }
          return fullText;
        } catch (error) {
          console.error("Streaming API call failed:", error);
          throw new Error(error.message || "An error occurred during the request.");
        }
      };

      const askQuestionAboutResume = (resumeText, question, jobDescription) => {
        const prompt = `You are an expert career coach and hiring manager. Your task is to provide insightful answers to questions about a candidate's resume, considering the context of a specific job description. Be helpful, insightful, and constructive. Go beyond what is just written in the resume and provide strategic advice.\n\nJOB DESCRIPTION CONTEXT:\n${jobDescription}\n\nCANDIDATE'S RESUME:\n${resumeText}\n\nUSER'S QUESTION:\n${question}\n\nYOUR INSIGHTFUL ANSWER:`;
        return streamApiCall(prompt);
      };

      const askConsultant = (jobDescription, resumes, messages) => {
        const resumeFileNames = resumes.map(r => r.fileName).join(', ') || 'None';
        const conversationHistory = messages.map(msg => `${msg.role}: ${msg.content}`).join('\n');
        const prompt = `You are an AI-powered Career and Recruitment Consultant. You have been provided with the context of a job description, a list of resume filenames that have been uploaded, and the current conversation history. Your goal is to provide expert advice.\n\nCONTEXT:\n- Job Description: ${jobDescription || 'Not provided yet.'}\n- Resumes Uploaded: ${resumeFileNames}\n- Conversation History:\n${conversationHistory}\n\nBased on all available context, provide a helpful and concise answer to the user's last message. Do not repeat the context in your answer.`;
        return streamApiCall(prompt);
      };
      
      const generateResumeFromDetails = (data) => {
        const experienceSection = data.workExperience.map(exp => `Company: ${exp.company}\nJob Title: ${exp.jobTitle}\nDates: ${exp.startDate} - ${exp.endDate}\nResponsibilities:\n${exp.responsibilities}`).join('\n\n');
        const educationSection = data.education.map(edu => `School: ${edu.school}\nDegree: ${edu.degree}\nDates: ${edu.startDate} - ${edu.endDate}`).join('\n\n');
        const prompt = `You are a professional resume writer. Your task is to generate a complete, well-formatted resume in plain text based on the structured data provided by a user. Use strong action verbs and a professional tone.\n\nUSER DATA:\n- Full Name: ${data.fullName}\n- Email: ${data.email}\n- Phone Number: ${data.phoneNumber}\n- Address: ${data.address}\n- Professional Summary: ${data.summary}\n- Work Experience:\n${experienceSection}\n- Education:\n${educationSection}\n- Skills: ${data.skills}\n\nGenerate the complete resume text based on the data above. Ensure clean formatting with clear headings (e.g., SUMMARY, WORK EXPERIENCE, EDUCATION, SKILLS). Do not include any introductory or concluding text. Just provide the resume content itself.`;
        return streamApiCall(prompt);
      };

      // --- HOOKS: useHistory.js ---
      const useHistory = () => {
        const HISTORY_STORAGE_KEY = 'resumeScreenerHistory';
        const [history, setHistory] = useState([]);

        useEffect(() => {
          try {
            const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
            if (storedHistory) setHistory(JSON.parse(storedHistory));
          } catch (error) {
            console.error("Failed to load history from localStorage:", error);
            setHistory([]);
          }
        }, []);

        const saveHistory = useCallback((newHistory) => {
          try {
            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(newHistory));
            setHistory(newHistory);
          } catch (error) {
            console.error("Failed to save history to localStorage:", error);
          }
        }, []);

        const addHistoryEntry = useCallback((data) => {
          const { jobDescription, resumes, analysisResults } = data;
          const title = jobDescription.split('\n').find(line => line.trim() !== '')?.trim() || 'Untitled Screening';
          const newEntry = {
            id: `hist_${Date.now()}`,
            timestamp: new Date().toISOString(),
            title: title.length > 50 ? `${title.substring(0, 50)}...` : title,
            jobDescription, resumes, analysisResults,
          };
          saveHistory([newEntry, ...history]);
        }, [history, saveHistory]);

        const removeHistoryEntry = useCallback((id) => {
          saveHistory(history.filter(entry => entry.id !== id));
        }, [history, saveHistory]);

        const clearHistory = useCallback(() => saveHistory([]), [saveHistory]);
        return { history, addHistoryEntry, removeHistoryEntry, clearHistory };
      };

      // --- COMPONENTS (in order of dependency) ---
      const ScoreDisplay = ({ score }) => {
        const getScoreColor = (s) => {
          if (s >= 8) return 'from-green-400 to-cyan-400 shadow-green-400/50';
          if (s >= 5) return 'from-yellow-400 to-orange-400 shadow-yellow-400/50';
          return 'from-red-500 to-pink-500 shadow-red-500/50';
        };
        return <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold shadow-lg bg-gradient-to-br text-white ${getScoreColor(score)}`}>{score}</div>;
      };

      const Placeholder = () => (
        <div className="flex flex-col items-center justify-center h-full text-center text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 mb-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
          <h3 className="text-lg font-semibold">Awaiting Input</h3>
          <p className="max-w-xs mt-1">Analysis of candidate datapads will appear here.</p>
        </div>
      );

      const ErrorDisplay = ({ message }) => (
        <div className="flex flex-col items-center justify-center h-full text-center text-red-400 bg-red-900/30 p-4 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <h3 className="text-lg font-semibold">Anomaly Detected</h3>
          <p className="max-w-md mt-1 text-sm">{message}</p>
        </div>
      );

      const CandidateCard = ({ candidate, resumeText, jobDescription }) => {
        const [question, setQuestion] = useState('');
        const [answer, setAnswer] = useState(null);
        const [isAsking, setIsAsking] = useState(false);
        const [askError, setAskError] = useState(null);

        const handleAskQuestion = async () => {
          if (!question.trim()) return;
          setIsAsking(true);
          setAnswer(null);
          setAskError(null);
          try {
            setAnswer(await askQuestionAboutResume(resumeText, question, jobDescription));
          } catch (err) {
            setAskError(err.message || 'An error occurred.');
          } finally {
            setIsAsking(false);
          }
        };

        return (
          <div className="bg-slate-800/50 backdrop-blur-sm p-5 rounded-lg border border-slate-700 shadow-sm transition-all hover:shadow-glow hover:shadow-cyan-500/30 hover:border-cyan-500/50">
            <div className="flex items-start justify-between gap-4">
              <div>
                <h3 className="text-xl font-bold text-cyan-400">{candidate.name}</h3>
                <p className="text-sm font-medium text-slate-300">Match Score</p>
              </div>
              <ScoreDisplay score={candidate.matchScore} />
            </div>
            <div className="mt-4">
              <h4 className="font-semibold text-slate-200">Justification</h4>
              <p className="text-sm text-slate-400 mt-1">{candidate.justification}</p>
            </div>
            <div className="mt-4">
              <h4 className="font-semibold text-slate-200">Experience Summary</h4>
              <p className="text-sm text-slate-400 mt-1">{candidate.extractedExperienceSummary}</p>
            </div>
            <div className="mt-4">
              <h4 className="font-semibold text-slate-200 mb-2">Relevant Skills</h4>
              <div className="flex flex-wrap gap-2">
                {candidate.extractedSkills.map((skill, index) => (
                  <span key={index} className="bg-pink-500/20 text-pink-300 text-xs font-semibold px-2.5 py-1 rounded-full border border-pink-500/30 shadow-sm">{skill}</span>
                ))}
              </div>
            </div>
            <div className="mt-5 pt-5 border-t border-slate-700">
              <h4 className="font-semibold text-slate-200 mb-2">Ask AI Assistant</h4>
              <div className="flex flex-col gap-2">
                <textarea value={question} onChange={(e) => setQuestion(e.target.value)} placeholder={`e.g., "How can I enhance this candidate's profile for this role?"`} className="w-full h-20 p-2 bg-slate-800/50 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-pink-500 transition-colors duration-300 text-sm" disabled={isAsking} />
                <button onClick={handleAskQuestion} disabled={!question.trim() || isAsking} className="w-full bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-glow shadow-pink-600/50 hover:shadow-glow-lg hover:shadow-pink-600/50 disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2">
                  {isAsking ? (<><LoadingSpinner /> Querying...</>) : (<><SparklesIcon className="w-5 h-5" /> Ask Question</>)}
                </button>
              </div>
              {askError && <p className="mt-3 text-sm text-red-400 bg-red-900/40 p-2 rounded-md">{askError}</p>}
              {answer && <div className="mt-3 p-3 bg-slate-800/70 rounded-lg"><h5 className="font-bold text-sm text-cyan-400">Answer:</h5><p className="text-sm text-slate-300 mt-1 whitespace-pre-wrap">{answer}</p></div>}
            </div>
          </div>
        );
      };

      const HistorySidebar = ({ history, onLoadEntry, onDeleteEntry, onClearHistory, currentJobDescription }) => (
        <aside className="bg-slate-900/50 backdrop-blur-md border border-slate-700 rounded-lg p-4 flex flex-col h-full max-h-[calc(100vh-120px)]">
            <div className="flex items-center justify-between mb-4 pb-4 border-b border-slate-700">
              <div className="flex items-center gap-3"><HistoryIcon className="w-6 h-6 text-cyan-400" /><h2 className="text-xl font-bold text-slate-200">Session Archives</h2></div>
              {history.length > 0 && <button onClick={onClearHistory} className="text-sm text-red-400 hover:text-red-300 font-semibold" aria-label="Clear all history">Clear All</button>}
            </div>
            <div className="flex-grow overflow-y-auto pr-2 -mr-2">
              {history.length === 0 ? (
                <div className="text-center text-slate-400 pt-10"><p>No archives found.</p><p className="text-sm mt-1">Completed scans will appear here.</p></div>
              ) : (
                <ul className="space-y-2">
                  {history.map(entry => {
                    const isActive = entry.jobDescription === currentJobDescription && entry.analysisResults?.length > 0;
                    return (
                      <li key={entry.id} className="group">
                        <div onClick={() => onLoadEntry(entry)} className={`p-3 rounded-lg cursor-pointer transition-colors duration-200 ${isActive ? 'bg-cyan-500/10 border border-cyan-500' : 'bg-slate-800/50 hover:bg-slate-700/70'}`}>
                          <div className="flex justify-between items-start">
                            <p className={`font-semibold text-sm truncate pr-2 ${isActive ? 'text-cyan-300' : 'text-slate-200'}`} title={entry.title}>{entry.title}</p>
                            <button onClick={(e) => { e.stopPropagation(); onDeleteEntry(entry.id); }} className="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-400 transition-opacity" aria-label="Delete this entry"><TrashIcon className="w-4 h-4" /></button>
                          </div>
                          <div className="flex items-center gap-1.5 text-xs text-slate-400 mt-1.5"><ClockIcon className="w-3 h-3" /><span>{new Date(entry.timestamp).toLocaleString()}</span></div>
                        </div>
                      </li>
                    );
                  })}
                </ul>
              )}
            </div>
        </aside>
      );

      const PresetRolesSelector = ({ onSelect }) => {
        const handleSelectionChange = (e) => {
          const selectedTitle = e.target.value;
          const selectedRole = PRESET_ROLES.find(role => role.title === selectedTitle);
          if (selectedRole) onSelect(selectedRole.description);
        };
        return (
          <div className="relative">
            <select onChange={handleSelectionChange} className="appearance-none w-full sm:w-auto bg-slate-800/50 border border-slate-600 text-slate-300 text-sm font-semibold rounded-md py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors" defaultValue="">
              <option value="" disabled>-- Select a Preset Role --</option>
              {PRESET_ROLES.map(role => <option key={role.title} value={role.title}>{role.title}</option>)}
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400"><svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.516 7.548c.436-.446 1.144-.446 1.58 0L10 10.42l2.904-2.872c.436-.446 1.144-.446 1.58 0 .436.446.436 1.167 0 1.613l-3.694 3.664a1.12 1.12 0 01-1.58 0L5.516 9.16c-.436-.446-.436-1.167 0-1.613z" /></svg></div>
          </div>
        );
      };

      const JobDescriptionInput = ({ value, onChange }) => (
        <div className="bg-slate-900/50 backdrop-blur-md border border-slate-700 p-6 rounded-lg">
          <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-2">
            <label htmlFor="job-description" className="block text-xl font-bold text-slate-200">Job Description</label>
            <PresetRolesSelector onSelect={onChange} />
          </div>
          <p className="text-sm text-slate-400 mb-4">Select a preset role or paste the mission parameters below.</p>
          <textarea id="job-description" value={value} onChange={(e) => onChange(e.target.value)} placeholder="e.g., Senior React Developer with experience in TypeScript and Next.js..." className="w-full h-48 p-3 bg-slate-800/50 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors duration-300" />
        </div>
      );

      const ResumeInput = ({ resumes, onAddResume, onRemoveResume, onFileChange, isParsing }) => {
        const [pastedText, setPastedText] = useState('');
        const handleAddClick = () => { onAddResume(pastedText); setPastedText(''); };
        return (
          <div className="bg-slate-900/50 backdrop-blur-md border border-slate-700 p-6 rounded-lg">
            <h2 className="text-xl font-bold mb-2 text-slate-200">Candidate Resumes</h2>
            <p className="text-sm text-slate-400 mb-4">Upload text or PDF files, or paste resume content below.</p>
            <div className="flex flex-col sm:flex-row gap-4 mb-4">
              <label className={`w-full flex-1 font-bold py-2 px-4 rounded-lg text-center transition-all duration-300 ${isParsing ? 'bg-slate-700 text-slate-400 cursor-not-allowed' : 'bg-slate-800/50 hover:bg-slate-700 border border-slate-600 text-slate-300 cursor-pointer'}`}>
                {isParsing ? (<span className="flex items-center justify-center gap-2"><LoadingSpinner /> Parsing Datapads...</span>) : 'Upload Files (.txt, .pdf)'}
                <input type="file" className="hidden" accept=".txt,.pdf" multiple onChange={(e) => onFileChange(e.target.files)} disabled={isParsing} />
              </label>
            </div>
            <div className="mb-4">
              <textarea value={pastedText} onChange={(e) => setPastedText(e.target.value)} placeholder="Or paste resume text here..." className="w-full h-24 p-3 bg-slate-800/50 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors duration-300" />
              <button onClick={handleAddClick} disabled={!pastedText.trim()} className="mt-2 w-full bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-glow shadow-pink-600/50 hover:shadow-glow-lg hover:shadow-pink-600/50 disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300">Add Pasted Resume</button>
            </div>
            <div className="space-y-2">
              {resumes.map((resume, index) => (
                <div key={resume.id} className="flex items-center justify-between bg-slate-800/60 p-2 rounded-md">
                  <span className="text-sm font-medium truncate text-slate-300" title={resume.fileName}>{index + 1}. {resume.fileName}</span>
                  <button onClick={() => onRemoveResume(resume.id)} className="text-red-400 hover:text-red-300 font-bold text-lg p-1" aria-label="Remove resume">&times;</button>
                </div>
              ))}
            </div>
          </div>
        );
      };

      const AiConsultantModal = ({ isOpen, onClose, messages, onAsk, isLoading, error }) => {
        const [question, setQuestion] = useState('');
        const messagesEndRef = useRef(null);
        useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isLoading]);
        const handleSubmit = (e) => {
          e.preventDefault();
          if (question.trim() && !isLoading) { onAsk(question); setQuestion(''); }
        };
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
            <div className="bg-slate-900/70 backdrop-blur-lg border border-slate-700 rounded-lg shadow-2xl w-full max-w-2xl h-[70vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
              <header className="flex items-center justify-between p-4 border-b border-slate-700">
                <div className="flex items-center gap-3"><LightbulbIcon className="w-6 h-6 text-cyan-400" /><h2 className="text-xl font-bold text-slate-200">AI Recruitment Consultant</h2></div>
                <button onClick={onClose} className="text-slate-400 hover:text-slate-100 text-2xl">&times;</button>
              </header>
              <main className="flex-grow p-4 overflow-y-auto">
                <div className="space-y-4">
                  {messages.length === 0 && <div className="text-center text-slate-400 p-8"><p>Welcome! I'm your AI Recruitment Consultant.</p><p className="text-sm mt-2">Ask me anything about your job description or how to screen candidates!</p></div>}
                  {messages.map((msg, index) => (
                    <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-prose p-3 rounded-lg ${msg.role === 'user' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-200'}`}><p className="text-sm whitespace-pre-wrap">{msg.content}</p></div>
                    </div>
                  ))}
                  {isLoading && <div className="flex justify-start"><div className="max-w-prose p-3 rounded-lg bg-slate-700 text-slate-200"><LoadingSpinner /></div></div>}
                  <div ref={messagesEndRef} />
                </div>
                {error && <p className="mt-2 text-sm text-red-400">{error}</p>}
              </main>
              <footer className="p-4 border-t border-slate-700">
                <form onSubmit={handleSubmit} className="flex items-center gap-3">
                  <input type="text" value={question} onChange={(e) => setQuestion(e.target.value)} placeholder="Ask for advice..." className="w-full p-2 bg-slate-800 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors duration-300" disabled={isLoading} />
                  <button type="submit" disabled={!question.trim() || isLoading} className="bg-cyan-500 text-white p-2 rounded-lg shadow-glow shadow-cyan-500/50 hover:shadow-glow-lg hover:shadow-cyan-500/50 disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300"><SendIcon className="w-6 h-6" /></button>
                </form>
              </footer>
            </div>
          </div>
        );
      };

      const FallingStarsBackground = () => {
        useEffect(() => {
          if (document.getElementById('falling-stars-styles')) return;
          const generateShadows = (n) => {
            let shadows = '';
            for (let i = 0; i < n; i++) shadows += `${Math.random() * 2000}px ${Math.random() * 2000}px ${Math.random() * 1.5}px rgba(255, 255, 255, ${0.5 + Math.random() * 0.5}),`;
            return shadows.slice(0, -1);
          };
          const css = `
            .stars-container{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at 70% 30%, rgba(14, 116, 144, 0.2) 0%, transparent 40%),radial-gradient(ellipse at 20% 80%, rgba(109, 40, 217, 0.15) 0%, transparent 50%),radial-gradient(ellipse at 90% 85%, rgba(190, 24, 93, 0.15) 0%, transparent 40%),radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);overflow:hidden;z-index:-10;}
            #stars,#stars2,#stars3{position:absolute;top:0;left:0;right:0;bottom:0;background:transparent;animation:animStar linear infinite;}
            #stars:after,#stars2:after,#stars3:after{content:" ";position:absolute;left:0;top:2000px;width:inherit;height:inherit;background:transparent;box-shadow:inherit;}
            #stars{width:1px;height:1px;box-shadow:${generateShadows(700)};animation-duration:50s;}
            #stars2{width:2px;height:2px;box-shadow:${generateShadows(200)};animation-duration:100s;}
            #stars3{width:3px;height:3px;box-shadow:${generateShadows(100)};animation-duration:150s;}
            @keyframes animStar{from{transform:translateY(0px)}to{transform:translateY(-2000px)}}`;
          const style = document.createElement('style');
          style.id = 'falling-stars-styles';
          style.innerHTML = css;
          document.head.appendChild(style);
        }, []);
        return (
          <div className="stars-container">
            <div id="stars"></div><div id="stars2"></div><div id="stars3"></div>
          </div>
        );
      };

      const Header = ({ activeView, setActiveView }) => {
        const NavButton = ({ view, children }) => (
          <button onClick={() => setActiveView(view)} className={`px-4 py-2 rounded-md text-sm font-bold transition-colors duration-300 ${activeView === view ? 'bg-cyan-500/20 text-cyan-300' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>
            {children}
          </button>
        );
        return (
          <header className="bg-slate-900/50 backdrop-blur-md border-b border-cyan-300/20 sticky top-0 z-20">
            <div className="container mx-auto px-4 md:px-8 py-4 flex flex-col sm:flex-row justify-between items-center gap-4">
              <div>
                <h1 className="text-3xl font-bold text-cyan-300 text-shadow-glow shadow-cyan-300/50">Smart Resume Screener</h1>
                <p className="text-slate-400 mt-1 text-sm sm:text-base">Your AI-powered career co-pilot.</p>
              </div>
              <nav className="flex items-center gap-2 p-1 bg-slate-800/50 border border-slate-700 rounded-lg">
                <NavButton view="screener">Resume Screener</NavButton>
                <NavButton view="builder">Resume Builder</NavButton>
              </nav>
            </div>
          </header>
        );
      };

      const AiConsultantButton = ({ onClick }) => (
        <button onClick={onClick} className="fixed bottom-6 right-6 bg-cyan-500 text-white w-20 h-20 rounded-full shadow-glow shadow-cyan-500/50 hover:shadow-glow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-cyan-400 transition-all duration-300 flex items-center justify-center z-50 animate-pulse-glow" aria-label="Ask AI Recruitment Consultant">
          <div className="flex items-center justify-center flex-col text-xs font-bold"><LightbulbIcon className="w-8 h-8" /><span>Ask AI</span></div>
        </button>
      );
      
      const FormSection = ({ title, children }) => (
        <div className="bg-slate-900/50 backdrop-blur-md border border-slate-700 p-6 rounded-lg">
          <h3 className="text-xl font-bold mb-4 text-cyan-400">{title}</h3>
          {children}
        </div>
      );
      
      const InputField = ({ name, label, value, onChange, placeholder, isTextArea = false }) => (
        <div>
          <label htmlFor={name} className="block text-sm font-medium text-slate-300 mb-1">{label}</label>
          {isTextArea ? (
            <textarea id={name} name={name} value={value} onChange={onChange} placeholder={placeholder} rows={4} className="w-full p-2 bg-slate-800/70 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-pink-500 transition-colors" />
          ) : (
            <input type="text" id={name} name={name} value={value} onChange={onChange} placeholder={placeholder} className="w-full p-2 bg-slate-800/70 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-pink-500 transition-colors" />
          )}
        </div>
      );

      const ResumeBuilder = () => {
        const initialFormData = {
          fullName: '', email: '', phoneNumber: '', address: '', summary: '',
          workExperience: [{ id: `exp_${Date.now()}`, company: '', jobTitle: '', startDate: '', endDate: '', responsibilities: '' }],
          education: [{ id: `edu_${Date.now()}`, school: '', degree: '', startDate: '', endDate: '' }],
          skills: '',
        };

        const [formData, setFormData] = useState(initialFormData);
        const [generatedResume, setGeneratedResume] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [isCopied, setIsCopied] = useState(false);

        const handleInputChange = (e) => {
          const { name, value } = e.target;
          setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleNestedChange = (section, id, e) => {
          const { name, value } = e.target;
          setFormData(prev => ({
            ...prev,
            [section]: prev[section].map(item =>
              item.id === id ? { ...item, [name]: value } : item
            ),
          }));
        };
        
        const addEntry = (section) => {
          const newEntry = section === 'workExperience'
            ? { id: `exp_${Date.now()}`, company: '', jobTitle: '', startDate: '', endDate: '', responsibilities: '' }
            : { id: `edu_${Date.now()}`, school: '', degree: '', startDate: '', endDate: '' };
          setFormData(prev => ({ ...prev, [section]: [...prev[section], newEntry] }));
        };

        const removeEntry = (section, id) => {
          setFormData(prev => ({ ...prev, [section]: prev[section].filter(item => item.id !== id) }));
        };

        const handleGenerateResume = async () => {
          setIsLoading(true);
          setError(null);
          setGeneratedResume(null);
          try {
            const result = await generateResumeFromDetails(formData);
            setGeneratedResume(result);
          } catch (err) {
            setError(err.message || 'An error occurred while generating the resume.');
          } finally {
            setIsLoading(false);
          }
        };
        
        const handleCopyToClipboard = () => {
          if (!generatedResume) return;
          navigator.clipboard.writeText(generatedResume).then(() => {
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
          });
        };

        return (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div className="flex flex-col gap-6">
              <FormSection title="Personal Details">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputField name="fullName" label="Full Name" value={formData.fullName} onChange={handleInputChange} />
                  <InputField name="email" label="Email" value={formData.email} onChange={handleInputChange} />
                  <InputField name="phoneNumber" label="Phone Number" value={formData.phoneNumber} onChange={handleInputChange} />
                  <InputField name="address" label="Address" value={formData.address} onChange={handleInputChange} />
                </div>
              </FormSection>
              <FormSection title="Professional Summary">
                  <InputField name="summary" label="Summary" value={formData.summary} onChange={handleInputChange} placeholder="A brief summary of your career..." isTextArea />
              </FormSection>
              <FormSection title="Work Experience">
                {formData.workExperience.map((exp, index) => (
                  <div key={exp.id} className="grid grid-cols-1 md:grid-cols-2 gap-4 border-b border-slate-700 pb-4 mb-4">
                    <InputField name="jobTitle" label="Job Title" value={exp.jobTitle} onChange={(e) => handleNestedChange('workExperience', exp.id, e)} />
                    <InputField name="company" label="Company" value={exp.company} onChange={(e) => handleNestedChange('workExperience', exp.id, e)} />
                    <InputField name="startDate" label="Start Date" value={exp.startDate} onChange={(e) => handleNestedChange('workExperience', exp.id, e)} />
                    <div className="relative">
                      <InputField name="endDate" label="End Date" value={exp.endDate} onChange={(e) => handleNestedChange('workExperience', exp.id, e)} />
                      {formData.workExperience.length > 1 && <button onClick={() => removeEntry('workExperience', exp.id)} className="absolute top-0 right-0 text-red-400 hover:text-red-300"><TrashIcon className="w-5 h-5"/></button>}
                    </div>
                    <div className="md:col-span-2">
                      <InputField name="responsibilities" label="Responsibilities" value={exp.responsibilities} onChange={(e) => handleNestedChange('workExperience', exp.id, e)} isTextArea placeholder="Describe your key achievements..."/>
                    </div>
                  </div>
                ))}
                <button onClick={() => addEntry('workExperience')} className="flex items-center gap-2 text-cyan-400 font-semibold"><PlusIcon className="w-5 h-5"/> Add Experience</button>
              </FormSection>
              <FormSection title="Education">
                {formData.education.map((edu) => (
                  <div key={edu.id} className="grid grid-cols-1 md:grid-cols-2 gap-4 border-b border-slate-700 pb-4 mb-4">
                    <InputField name="school" label="School / University" value={edu.school} onChange={(e) => handleNestedChange('education', edu.id, e)} />
                    <InputField name="degree" label="Degree / Field of Study" value={edu.degree} onChange={(e) => handleNestedChange('education', edu.id, e)} />
                    <InputField name="startDate" label="Start Date" value={edu.startDate} onChange={(e) => handleNestedChange('education', edu.id, e)} />
                    <div className="relative">
                      <InputField name="endDate" label="End Date" value={edu.endDate} onChange={(e) => handleNestedChange('education', edu.id, e)} />
                      {formData.education.length > 1 && <button onClick={() => removeEntry('education', edu.id)} className="absolute top-0 right-0 text-red-400 hover:text-red-300"><TrashIcon className="w-5 h-5"/></button>}
                    </div>
                  </div>
                ))}
                <button onClick={() => addEntry('education')} className="flex items-center gap-2 text-cyan-400 font-semibold"><PlusIcon className="w-5 h-5"/> Add Education</button>
              </FormSection>
              <FormSection title="Skills">
                  <InputField name="skills" label="Skills" value={formData.skills} onChange={handleInputChange} placeholder="e.g., JavaScript, React, Node.js, Project Management" isTextArea />
              </FormSection>
            </div>
            <div className="flex flex-col gap-6">
              <div className="bg-slate-900/50 backdrop-blur-md border border-slate-700 p-6 rounded-lg flex-grow flex flex-col">
                  <h2 className="text-2xl font-bold mb-4 text-slate-200">Generated Resume</h2>
                  <div className="flex-grow relative bg-slate-800/50 rounded-md p-4 min-h-[300px]">
                      {isLoading && (
                        <div className="absolute inset-0 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm rounded-lg z-10">
                            <div className="text-center">
                                <LoadingSpinner />
                                <p className="mt-2 text-lg font-semibold text-cyan-400">AI is writing your resume...</p>
                            </div>
                        </div>
                      )}
                      {error && <ErrorDisplay message={error} />}
                      {!isLoading && !error && generatedResume && <pre className="text-sm text-slate-200 whitespace-pre-wrap font-sans">{generatedResume}</pre>}
                      {!isLoading && !error && !generatedResume && <div className="flex items-center justify-center h-full text-center text-slate-400"><p>Your generated resume will appear here.</p></div>}
                  </div>
                  {generatedResume && <button onClick={handleCopyToClipboard} className="mt-4 w-full bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-glow shadow-pink-600/50 hover:shadow-glow-lg hover:shadow-pink-600/50 transition-all duration-300 flex items-center justify-center gap-2"><ClipboardIcon className="w-5 h-5" />{isCopied ? 'Copied!' : 'Copy to Clipboard'}</button>}
              </div>
              <button onClick={handleGenerateResume} disabled={isLoading} className="w-full bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg shadow-glow shadow-cyan-500/50 hover:shadow-glow-lg hover:shadow-cyan-500/50 disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2">
                {isLoading ? (<><LoadingSpinner /> Generating...</>) : (<><SparklesIcon className="w-5 h-5" /> Generate Resume with AI</>)}
              </button>
            </div>
          </div>
        );
      };


      // --- MAIN APP COMPONENT ---
      const App = () => {
        const [activeView, setActiveView] = useState('screener');
        const [jobDescription, setJobDescription] = useState('');
        const [resumes, setResumes] = useState([]);
        const [analysisResults, setAnalysisResults] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [isParsing, setIsParsing] = useState(false);
        const [error, setError] = useState(null);
        const [isConsultantModalOpen, setIsConsultantModalOpen] = useState(false);
        const [consultantMessages, setConsultantMessages] = useState([]);
        const [isConsultantLoading, setIsConsultantLoading] = useState(false);
        const [consultantError, setConsultantError] = useState(null);
        const { history, addHistoryEntry, removeHistoryEntry, clearHistory } = useHistory();

        const handleAddResume = (text) => {
            if (text.trim()) {
            const newResume = { id: `resume_${Date.now()}_${resumes.length + 1}`, text, fileName: `Pasted Resume ${resumes.length + 1}` };
            setResumes(prev => [...prev, newResume]);
            setAnalysisResults(null);
            }
        };

        const handleFileChange = async (files) => {
            if (!files || files.length === 0) return;
            setIsParsing(true);
            setError(null);
            setAnalysisResults(null);
            try {
            const parsedResumesPromises = Array.from(files).map(async (file) => {
                const text = await parseFile(file);
                return { id: `resume_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, text, fileName: file.name };
            });
            const newResumes = await Promise.all(parsedResumesPromises);
            setResumes(prev => [...prev, ...newResumes.filter(r => r.text.trim())]);
            } catch (err) {
            setError(err.message || 'An error occurred while parsing the files.');
            } finally {
            setIsParsing(false);
            }
        };

        const handleRemoveResume = (id) => { setResumes(prev => prev.filter(r => r.id !== id)); setAnalysisResults(null); };
        const handleJobDescriptionChange = (value) => { setJobDescription(value); setAnalysisResults(null); };

        const handleScreenResumes = async () => {
            if (!jobDescription.trim() || resumes.length === 0) {
              setError('Please provide a job description and at least one resume.');
              return;
            }
            setError(null);
            setIsLoading(true);
            setAnalysisResults(null);
            try {
              const results = await analyzeResumes(jobDescription, resumes);
              results.sort((a, b) => b.matchScore - a.matchScore);
              setAnalysisResults(results);
              addHistoryEntry({ jobDescription, resumes, analysisResults: results });
            } catch (err) {
              console.error("Screening Error:", err);
              setError(err.message || 'An error occurred during analysis.');
            } finally {
              setIsLoading(false);
            }
        };

        const handleLoadHistoryEntry = (entry) => {
            setJobDescription(entry.jobDescription);
            setResumes(entry.resumes);
            setAnalysisResults(entry.analysisResults);
            setError(null);
            setIsLoading(false);
            setActiveView('screener');
        };

        const handleAskConsultant = async (question) => {
            const newMessages = [...consultantMessages, { role: 'user', content: question }];
            setConsultantMessages(newMessages);
            setIsConsultantLoading(true);
            setConsultantError(null);
            try {
              const response = await askConsultant(jobDescription, resumes, newMessages);
              setConsultantMessages(prev => [...prev, { role: 'assistant', content: response }]);
            } catch (err) {
              setConsultantError(err.message || "An error occurred while talking to the consultant.");
            } finally {
              setIsConsultantLoading(false);
            }
        };

        const canScreen = jobDescription.trim().length > 0 && resumes.length > 0 && !isLoading && !isParsing;
        
        return (
            <div className="min-h-screen text-slate-100 font-sans">
                <FallingStarsBackground />
                <Header activeView={activeView} setActiveView={setActiveView} />
                <div className="container mx-auto p-4 md:p-8 relative">
                    {activeView === 'screener' && (
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className="lg:col-span-3">
                                <HistorySidebar history={history} onLoadEntry={handleLoadHistoryEntry} onDeleteEntry={removeHistoryEntry} onClearHistory={clearHistory} currentJobDescription={jobDescription} />
                            </div>
                            <main className="lg:col-span-9 grid grid-cols-1 xl:grid-cols-2 gap-8">
                                <div className="flex flex-col gap-6">
                                    <JobDescriptionInput value={jobDescription} onChange={handleJobDescriptionChange} />
                                    <ResumeInput resumes={resumes} onAddResume={handleAddResume} onRemoveResume={handleRemoveResume} onFileChange={handleFileChange} isParsing={isParsing} />
                                    <button onClick={handleScreenResumes} disabled={!canScreen} className="w-full bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg shadow-glow shadow-cyan-500/50 hover:shadow-glow-lg hover:shadow-cyan-500/50 disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2">
                                        {isLoading ? (<><LoadingSpinner /> Scanning Sector...</>) : ('Engage Hyperdrive')}
                                    </button>
                                </div>
                                <div className="bg-slate-900/50 backdrop-blur-md border border-slate-700 p-6 rounded-lg min-h-[600px] flex flex-col">
                                    <h2 className="text-2xl font-bold mb-4 text-slate-200">Analysis Results</h2>
                                    <div className="flex-grow relative">
                                        {isLoading && <div className="absolute inset-0 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm rounded-lg z-10"><div className="text-center"><LoadingSpinner /><p className="mt-2 text-lg font-semibold text-cyan-400">Analyzing candidates...</p></div></div>}
                                        {error && <ErrorDisplay message={error} />}
                                        {!isLoading && !error && analysisResults && (
                                            <div className="space-y-4 overflow-y-auto max-h-[70vh] p-1">
                                                {analysisResults.map((candidate) => {
                                                    const originalResume = resumes.find(r => r.id === candidate.id);
                                                    if (!originalResume) return null;
                                                    return <CandidateCard key={candidate.id} candidate={candidate} resumeText={originalResume.text} jobDescription={jobDescription} />
                                                })}
                                            </div>
                                        )}
                                        {!isLoading && !error && !analysisResults && <Placeholder />}
                                    </div>
                                </div>
                            </main>
                        </div>
                    )}
                    {activeView === 'builder' && <ResumeBuilder />}
                </div>
                {activeView === 'screener' && <AiConsultantButton onClick={() => setIsConsultantModalOpen(true)} />}
                <AiConsultantModal isOpen={isConsultantModalOpen} onClose={() => setIsConsultantModalOpen(false)} messages={consultantMessages} onAsk={handleAskConsultant} isLoading={isConsultantLoading} error={consultantError} />
            </div>
        );
      };
      
      // --- WRAPPER FOR API KEY HANDLING ---
      const StandaloneApp = () => {
        const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key_standalone') || '');
        const [tempKey, setTempKey] = useState('');
        const [isKeyReady, setIsKeyReady] = useState(false);
        const [isVerifying, setIsVerifying] = useState(false);
        const [keyError, setKeyError] = useState('');

        useEffect(() => {
          if (apiKey) {
            setTempKey(apiKey);
            verifyKey(apiKey);
          }
        }, []);

        const verifyKey = async (keyToVerify) => {
          if (!keyToVerify) return;
          setIsVerifying(true);
          setKeyError('');
          try {
            const testAi = new GoogleGenAI({ apiKey: keyToVerify });
            await testAi.models.generateContent({ model: 'gemini-2.5-flash', contents: 'hello' });
            ai = testAi; // Set the global instance
            localStorage.setItem('gemini_api_key_standalone', keyToVerify);
            setApiKey(keyToVerify);
            setIsKeyReady(true);
          } catch (err) {
            console.error("API Key verification failed:", err);
            setKeyError('API key is not valid or there was a network error. Please check the key and your connection, then try again.');
            setIsKeyReady(false);
            localStorage.removeItem('gemini_api_key_standalone');
          } finally {
            setIsVerifying(false);
          }
        };

        const handleKeySubmit = (e) => {
          e.preventDefault();
          verifyKey(tempKey);
        };

        if (isKeyReady) {
          return <App />;
        }
        
        return (
          <div className="bg-slate-900 min-h-screen flex items-center justify-center font-sans text-slate-100 p-4">
            <FallingStarsBackground />
            <div className="w-full max-w-md bg-slate-800/50 backdrop-blur-md border border-slate-700 p-8 rounded-lg shadow-glow-lg shadow-cyan-500/20 z-10">
              <h1 className="text-3xl font-bold text-center text-cyan-300">Smart Resume Screener</h1>
              <p className="text-slate-400 text-center mt-2 mb-6">Please provide your Google Gemini API key to continue.</p>
              <form onSubmit={handleKeySubmit}>
                <input
                  type="password"
                  value={tempKey}
                  onChange={(e) => setTempKey(e.target.value)}
                  placeholder="Enter your API key"
                  className="w-full p-3 bg-slate-800 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors duration-300"
                />
                <button
                  type="submit"
                  disabled={isVerifying || !tempKey.trim()}
                  className="mt-4 w-full bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg shadow-glow shadow-cyan-500/50 hover:shadow-glow-lg hover:shadow-cyan-500/50 disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2"
                >
                  {isVerifying ? <><LoadingSpinner /> Verifying...</> : 'Start Application'}
                </button>
              </form>
              {keyError && <p className="mt-4 text-sm text-red-400 text-center">{keyError}</p>}
              <p className="text-xs text-slate-500 mt-6 text-center">Your API key is stored only in your browser's local storage and is never sent to any server except Google's.</p>
            </div>
          </div>
        );
      };

      // --- RENDER THE APP ---
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <StandaloneApp />
        </React.StrictMode>
      );
    </script>
</body>
</html>