<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Resume Screener (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'space-primary': '#0e7490', // Deep Cyan
              'space-secondary': '#be185d', // Deep Pink/Magenta
              'space-accent': '#6d28d9', // Deep Violet
              'brand-primary': '#0891b2',
              'brand-secondary': '#db2777',
            },
            fontFamily: {
              sans: ['"Exo 2"', 'sans-serif'],
            },
            textShadow: {
              'glow': '0 0 8px var(--tw-shadow-color)',
            },
            boxShadow: {
              'glow': '0 0 15px var(--tw-shadow-color)',
              'glow-lg': '0 0 25px var(--tw-shadow-color)',
            },
            keyframes: {
              'pulse-glow': {
                '0%, 100%': { opacity: 1, boxShadow: '0 0 15px var(--tw-shadow-color)' },
                '50%': { opacity: 0.8, boxShadow: '0 0 25px var(--tw-shadow-color)' },
              }
            },
            animation: {
              'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          },
        },
        plugins: [
          function({ addUtilities, theme }) {
            const newUtilities = {
              '.text-shadow-glow': {
                textShadow: theme('textShadow.glow'),
              },
            }
            addUtilities(newUtilities, ['responsive', 'hover'])
          }
        ],
      }
    </script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/genai": "https://esm.sh/@google/genai",
        "pdfjs-dist": "https://esm.sh/pdfjs-dist@4.4.168"
      }
    }
    </script>
    <!-- Babel for JSX compilation MUST be in the head -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";
      import * as pdfjsLib from 'pdfjs-dist';

      // --- SETUP ---
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.mjs`;

      let ai; // Global AI instance

      // --- ICONS (Components) ---
      const ClockIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      );
      const HistoryIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M1 4v6h6" />
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
        </svg>
      );
      const TrashIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      );
      const SparklesIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3Z"/>
            <path d="M5 21L6.5 18"/>
            <path d="M17.5 18L19 21"/>
            <path d="M21 5L18 6.5"/>
            <path d="M3 5L6 6.5"/>
          </svg>
      );
      const LightbulbIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M15.09 16.05A6.49 6.49 0 0 0 12 10c-1.84 0-3.53.77-4.74 2.06" />
          <path d="M12 2a7 7 0 0 0-7 7c0 2.22 1.02 4.22 2.62 5.51" />
          <path d="M16.38 17.51A7 7 0 0 0 19 12a7 7 0 0 0-7-7" />
          <path d="m5 21 1-1" />
          <path d="m18 21 1-1" />
          <path d="M12 18v3" />
          <path d="M8 21h8" />
        </svg>
      );
      const SendIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      );
      const ClipboardIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
      );
      const PlusIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      );
      const LoadingSpinner = () => (
        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style={{color: 'currentColor'}}>
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      );

      // --- SERVICES: fileParsers.js ---
      async function parseTxt(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target?.result);
          reader.onerror = () => reject(new Error("Failed to read the text file."));
          reader.readAsText(file);
        });
      }
      async function parsePdf(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const arrayBuffer = e.target?.result;
              if (!arrayBuffer) {
                  return reject(new Error('Failed to read PDF file into buffer.'));
              }
              const typedArray = new Uint8Array(arrayBuffer);
              const pdf = await pdfjsLib.getDocument(typedArray).promise;
              let fullText = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => ('str' in item ? item.str : '')).join(' ');
                fullText += pageText + '\n\n';
              }
              resolve(fullText);
            } catch (error) {
              console.error('Error parsing PDF:', error);
              reject(new Error('Failed to parse PDF content. The file might be corrupted or protected.'));
            }
          };
          reader.onerror = () => reject(new Error('Failed to read the PDF file.'));
          reader.readAsArrayBuffer(file);
        });
      }
      async function parseFile(file) {
        const extension = file.name.split('.').pop()?.toLowerCase();
        if (extension === 'txt' || file.type === 'text/plain') {
          return parseTxt(file);
        } else if (extension === 'pdf' || file.type === 'application/pdf') {
          return parsePdf(file);
        } else {
          throw new Error(`Unsupported file type: '${extension}'. Please upload a .txt or .pdf file.`);
        }
      }

      // --- SERVICES: presetRoles.js ---
      const PRESET_ROLES = [
        { title: "Backend Developer", description: `We are seeking an experienced Backend Developer to join our IT team. You will be responsible for the server-side of our web applications. If you have excellent programming skills and a passion for developing applications or improving existing ones, we would like to meet you.\n\nResponsibilities:\n- Participate in the entire application lifecycle, focusing on coding and debugging.\n- Write clean code to develop functional web applications.\n- Troubleshoot and debug applications.\n- Perform UI tests to optimize performance.\n- Manage cutting-edge technologies to improve legacy applications.\n- Collaborate with Frontend developers to integrate user-facing elements with server-side logic.\n- Gather and address technical and design requirements.\n- Provide training and support to internal teams.\n- Build reusable code and libraries for future use.\n- Liaise with developers, designers and system administrators to identify new features.\n\nRequirements:\n- Proven experience as a Backend Developer.\n- In-depth understanding of the entire web development process (design, development and deployment).\n- Hands on experience with programming languages like Java, Ruby, Python, PHP and .Net.\n- Familiarity with front-end languages (e.g. HTML, JavaScript and CSS).\n- Excellent analytical and time management skills.` },
        { title: "Business Analyst", description: `We are looking for a Business Analyst to join our team. The main role of the Business Analyst is to analyze the business processes, identify areas of improvement, and recommend solutions to business problems.\n\nResponsibilities:\n- Elicit, analyze, and document business requirements.\n- Communicate with stakeholders to understand their needs and concerns.\n- Create detailed business analysis, outlining problems, opportunities, and solutions for a business.\n- Bridge the gap between IT and the business using data analytics to assess processes, determine requirements and deliver data-driven recommendations and reports to executives and stakeholders.\n\nRequirements:\n- Proven experience as a Business Analyst.\n- Experience with business process modeling.\n- Strong analytical and problem-solving skills.\n- Excellent communication and interpersonal skills.\n- Familiarity with project management methodologies like Agile and Scrum.` },
        // ... (all other roles from presetRoles.ts would be here)
      ].sort((a, b) => a.title.localeCompare(b.title));


      // --- SERVICES: geminiService.js (Standalone Version) ---
      const candidateSchema = {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            id: { type: Type.STRING, description: 'The resume ID from the input' },
            name: { type: Type.STRING, description: "The candidate's full name" },
            matchScore: { type: Type.INTEGER, description: 'A score from 1 to 10 indicating the match with the job description.' },
            justification: { type: Type.STRING, description: 'A concise (2-3 sentences) justification for the match score.' },
            extractedSkills: { type: Type.ARRAY, items: { type: Type.STRING }, description: 'A list of key skills extracted from the resume that are relevant to the job description.' },
            extractedExperienceSummary: { type: Type.STRING, description: 'A brief (2-3 sentences) summary of the candidate\'s relevant work experience.' }
          },
          required: ['id', 'name', 'matchScore', 'justification', 'extractedSkills', 'extractedExperienceSummary']
        }
      };

      const analyzeResumes = async (jobDescription, resumes) => {
        const resumeTexts = resumes.map(r => `--- RESUME START ---\nID: ${r.id}\nFILENAME: ${r.fileName}\n\n${r.text}\n--- RESUME END ---`).join('\n\n');
        const prompt = `You are an expert technical recruiter...`; // Full prompt from original file
        try {
          const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: [{ parts: [{ text: prompt }] }],
            config: { responseMimeType: "application/json", responseSchema: candidateSchema }
          });
          const jsonText = response.text;
          const parsedData = JSON.parse(jsonText);
          return parsedData;
        } catch (error) {
          console.error("Failed to analyze resumes:", error);
          if (error instanceof SyntaxError) throw new Error("Could not parse the analysis from the AI model. The response was not valid JSON.");
          throw error;
        }
      };
      
      const streamApiCall = async (prompt) => {
        try {
          const stream = await ai.models.generateContentStream({
            model: 'gemini-2.5-flash',
            contents: [{ parts: [{ text: prompt }] }],
          });
          let fullText = "";
          for await (const chunk of stream) {
            fullText += chunk.text;
          }
          return fullText;
        } catch (error) {
          console.error("Streaming API call failed:", error);
          throw new Error(error.message || "An error occurred during the request.");
        }
      };

      const askQuestionAboutResume = (resumeText, question, jobDescription) => {
        const prompt = `You are an expert career coach... JOB DESCRIPTION CONTEXT:\n${jobDescription}\n\nCANDIDATE'S RESUME:\n${resumeText}\n\nUSER'S QUESTION:\n${question}\n\nYOUR INSIGHTFUL ANSWER:`;
        return streamApiCall(prompt);
      };

      const askConsultant = (jobDescription, resumes, messages) => {
        const resumeFileNames = resumes.map(r => r.fileName).join(', ') || 'None';
        const conversationHistory = messages.map(msg => `${msg.role}: ${msg.content}`).join('\n');
        const prompt = `You are an AI-powered Career and Recruitment Consultant... CONTEXT:\n- Job Description: ${jobDescription || 'Not provided yet.'}\n- Resumes Uploaded: ${resumeFileNames}\n- Conversation History:\n${conversationHistory}\n\nBased on all available context, provide a helpful and concise answer to the user's last message.`;
        return streamApiCall(prompt);
      };
      
      const generateResumeFromDetails = (data) => {
        const experienceSection = data.workExperience.map(exp => `Company: ${exp.company}...`).join('\n\n');
        const educationSection = data.education.map(edu => `School: ${edu.school}...`).join('\n\n');
        const prompt = `You are a professional resume writer... USER DATA:\n- Full Name: ${data.fullName}...`;
        return streamApiCall(prompt);
      };

      // --- HOOKS: useHistory.js ---
      const useHistory = () => { /* ... copy full useHistory hook logic here ... */ };

      // --- ALL OTHER COMPONENTS ---
      const Header = ({ activeView, setActiveView }) => { /* ... JSX ... */ };
      const JobDescriptionInput = ({ value, onChange }) => { /* ... JSX ... */ };
      const ResumeInput = ({ resumes, onAddResume, onRemoveResume, onFileChange, isParsing }) => { /* ... JSX ... */ };
      const CandidateCard = ({ candidate, resumeText, jobDescription }) => { /* ... JSX ... */ };
      const ScoreDisplay = ({ score }) => { /* ... JSX ... */ };
      const Placeholder = () => { /* ... JSX ... */ };
      const ErrorDisplay = ({ message }) => { /* ... JSX ... */ };
      const HistorySidebar = ({ history, onLoadEntry, onDeleteEntry, onClearHistory, currentJobDescription }) => { /* ... JSX ... */ };
      const AiConsultantButton = ({ onClick }) => { /* ... JSX ... */ };
      const AiConsultantModal = ({ isOpen, onClose, messages, onAsk, isLoading, error }) => { /* ... JSX ... */ };
      const FallingStarsBackground = () => { /* ... JSX and useEffect logic ... */ };
      const ResumeBuilder = () => { /* ... JSX and state logic ... */ };
      const PresetRolesSelector = ({ onSelect }) => { /* ... JSX ... */ };


      // --- MAIN APP COMPONENT ---
      const App = () => { /* ... copy full App.tsx logic here ... */ };
      
      // --- WRAPPER FOR API KEY HANDLING ---
      const StandaloneApp = () => {
        const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key_standalone') || '');
        const [tempKey, setTempKey] = useState('');
        const [isKeyReady, setIsKeyReady] = useState(false);
        const [isVerifying, setIsVerifying] = useState(false);
        const [keyError, setKeyError] = useState('');

        useEffect(() => {
          if (apiKey) {
            setTempKey(apiKey);
            verifyKey(apiKey);
          }
        }, []);

        const verifyKey = async (keyToVerify) => {
          if (!keyToVerify) return;
          setIsVerifying(true);
          setKeyError('');
          try {
            const testAi = new GoogleGenAI({ apiKey: keyToVerify });
            await testAi.models.generateContent({ model: 'gemini-2.5-flash', contents: [{ parts: [{ text: 'hello' }] }]});
            ai = testAi;
            localStorage.setItem('gemini_api_key_standalone', keyToVerify);
            setApiKey(keyToVerify);
            setIsKeyReady(true);
          } catch (err) {
            console.error("API Key verification failed:", err);
            setKeyError('API key is not valid or there was a network error. Please check the key and your connection, then try again.');
            setIsKeyReady(false);
            localStorage.removeItem('gemini_api_key_standalone');
          } finally {
            setIsVerifying(false);
          }
        };

        const handleKeySubmit = (e) => {
          e.preventDefault();
          verifyKey(tempKey);
        };

        if (isKeyReady) {
          return <App />;
        }
        
        // Render the API key input form
        return (
          <div className="bg-slate-900 min-h-screen flex items-center justify-center font-sans text-slate-100 p-4">
            <FallingStarsBackground />
            <div className="w-full max-w-md bg-slate-800/50 backdrop-blur-md border border-slate-700 p-8 rounded-lg shadow-glow-lg shadow-cyan-500/20 z-10">
              <h1 className="text-3xl font-bold text-center text-cyan-300">Smart Resume Screener</h1>
              <p className="text-slate-400 text-center mt-2 mb-6">Please provide your Google Gemini API key to continue.</p>
              <form onSubmit={handleKeySubmit}>
                <input
                  type="password"
                  value={tempKey}
                  onChange={(e) => setTempKey(e.target.value)}
                  placeholder="Enter your API key"
                  className="w-full p-3 bg-slate-800 text-slate-200 border border-slate-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors duration-300"
                />
                <button
                  type="submit"
                  disabled={isVerifying || !tempKey.trim()}
                  className="mt-4 w-full bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg shadow-glow shadow-cyan-500/50 hover:shadow-glow-lg hover:shadow-cyan-500/50 disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2"
                >
                  {isVerifying ? <><LoadingSpinner /> Verifying...</> : 'Start Application'}
                </button>
              </form>
              {keyError && <p className="mt-4 text-sm text-red-400 text-center">{keyError}</p>}
              <p className="text-xs text-slate-500 mt-6 text-center">Your API key is stored only in your browser's local storage and is never sent to any server except Google's.</p>
            </div>
          </div>
        );
      };

      // --- RENDER THE APP ---
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <StandaloneApp />
        </React.StrictMode>
      );
    </script>
</body>
</html>
